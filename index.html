<!DOCTYPE html>
<html lang="en">
<head>
	<title>Работа с изображениями на Python в 2017 году</title>
	<meta charset="utf-8">
	<meta http-equiv="x-ua-compatible" content="ie=edge">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<link rel="stylesheet" href="node_modules/shower-ribbon/styles/screen-16x10.css">
	<style type="text/css">
		.shower.full {
			margin:-288px 0 0 -512px;
			height: 576px;
		}
		.slide {
			height: 576px;
			padding: 62px 70px 0 100px;
		}
		.slide:after {
			top: -20px;
			padding-top: 25px;
		}

		.slide ol>li.non-zero::before {
			content: attr(data-counter) ".";
		}

		h4 {
			font-size: .8em;
		}
		h2 + h4 {
			position: relative;
			top: -1.2em;
		}
		.clarification {
			margin-left: 2em;
			line-height: 1.6em;
		}
		.gap {
			text-align: center;
		}
			.gap h2 {
				font-size: 100px;
				margin-top: 100px;
			}
		.slide ol + ol,
		.slide ul + ul {
			margin-top: -1em;
		}
		.stars {
			font-size: 50px;
			margin-top: -0.3em;
		}

		.red {
			color: rgb(200, 0, 0);
		}
	</style>
</head>
<body class="shower list">

	<header class="caption">
		<h1>Работа с изображениями на Python в 2017 году</h1>
	</header>

	<section class="slide" id="cover">
		<h2>Работа с изображениями на Python в 2017 году</h2>
		<p>Александр Карпинский, Uploadcare</p>
		<figure>
			<img class="cover" src="pictures/cover.jpg" alt="Hands on the orange typewriter in a park">
		</figure>
		<style>
		#cover {
			text-shadow: black 3px 4px 2px;
		}
			#cover figure:after {
				content: "";
				position: absolute;
				z-index: -1;
				top: 0; left: 0;
				width: 100%;
				height: 70%;
				background: linear-gradient(180deg, rgba(0,0,0,0.6) 0%, rgba(0,0,0,0) 100%);
			}
			#cover h2 {
				margin: 0;
				color:#FFF;
				text-align:center;
				font-size:70px;
				}
			#cover p {
				margin:10px 0 0;
				text-align:center;
				color:#FFF;
				font-size:36px;
				}
				#cover p a {
					color:#FFF;
					}
		</style>
	</section>

	<section class="slide">
		<h2>O себе</h2>
		<p>
			Член команды <a href="https://python-pillow.org/">Pillow</a>
		</p>
		<p>
			Автор форка <a href="https://github.com/uploadcare/pillow-simd">Pillow-SIMD</a>
		</p>
	</section>

	<section class="slide">
		<h2>Чем занимаюсь</h2>
		<p>
			Сервис обработки картинок на лету в Uploadcare
		</p>
		<p>Требования к графической библотеке:</p>
		<ul>
			<li>Производительность</li>
			<li>Всеядность</li>
			<li>Защита от DOS</li>
			<li>Простота работы</li>
		</ul>
	</section>



	<section class="slide gap">
		<h2>Библиотеки</h2>
	</section>

	<section class="slide">
		<h2>Pillow</h2>
		<ul>
			<li>Форк Python Imaging Library. 1995 год
			<li>Разработка ведется 3-месячными циклами
			<li>Ядро на Си. Нативное расширение для Python
			<li>Версии Python: 2.7, 3.3+, pypy, pypy3
			<li>Легкая установка из pypi
		</ul>
		<p>Сайт: <a href="https://python-pillow.org/">python-pillow.org</a></p>
	</section>

	<section class="slide">
		<h2>Pillow-SIMD</h2>
		<ul>
			<li>C мая 2016 года
			<li>Drop-in replacement for Pillow
			<li>Те же версии Python
			<li>Инснтрукции SSE4 (по умолчанию) и AVX2
			<li>Установка из pypi, нужен компилятор
		</ul>
		<p>Сайт: <a href="https://github.com/uploadcare/pillow-simd">github.com/uploadcare/pillow-simd</a></p>
	</section>

	<section class="slide">
		<h2>OpenCV</h2>
		<ul>
			<li>Расшифровывается Open Computer Vision. 2000 год
			<li>Биндинг на Python входит в комплект и очень популярен
			<li>Версии Python: 2.7, 3.4+, пока без pypy
			<li>Огромное количество функций компьютерного зрения
			<li>В pypi есть неофициальная сборка
		</ul>
		<p>Сайт: <a href="https://opencv.org/">opencv.org</a></p>
	</section>

	<section class="slide">
		<h2>VIPS</h2>
		<ul>
			<li>1993 года, обогнала своё время
			<li>Может работать в режиме стриминга
			<li>Биндинг pyvips поддерживается автором
			<li>Для работы нужно ставить или собирать пакеты
			<li>Версии Python: 2.7, 3.3+, pypy, pypy3
		</ul>
		<p>Сайт: <a href="https://jcupitt.github.io/libvips/">jcupitt.github.io/libvips/</a></p>
	</section>

	<section class="slide">
		<h2>ImageMagick &amp; GraphicsMagick</h2>
		<ul>
			<li>Очень популярная библиотека. 1990 год
			<li>Биндинг для питона: Wand и pgmagick
			<li>Wand использует ctypes, проект заброшен
			<li>pgmagick использует Boost.Python, не работает в pypy
			<li>Для работы нужно ставить пакеты
		</ul>
		<p>Сайт: <a href="https://www.imagemagick.org/">imagemagick.org</a>,
			<a href="http://graphicsmagick.org">graphicsmagick.org</a></p>
	</section>



	<section class="slide gap">
		<h2>Производительность</h2>
	</section>

	<section class="slide">
		<h2>Почему важно проверять результат</h2>
		<pre>
			<code>from PIL import Image, ImageFilter.BoxBlur</code>
			<code>im.filter(ImageFilter.BoxBlur(<mark>3</mark>))</code>
			<code>...</code>
		</pre>
		<pre>
			<code>import cv2</code>
			<code>cv2.blur(im, ksize=(<mark>3, 3</mark>))</code>
			<code>...</code>
		</pre>
	</section>

	<section class="slide">
		<h2>В чем проблема?</h2>
		<pre>
			<code>cv2.GaussianBlur(im, (window, window), radius)</code>
		</pre>
		<div style="columns: 2 auto">
			<div style="break-inside: avoid;">
				<code>radius = 3</code> <mark>58 ms</mark>
				<img src="./pictures/gaus.3.pillow.jpeg" width="90%">
			</div>
			<div style="break-inside: avoid;">
				<code>radius = 30</code> <mark>880 ms</mark>
				<img src="./pictures/gaus.30.pillow.jpeg" width="90%">
			</div>
		</div>
	</section>

	<section class="slide">
		<h2>В чем проблема?</h2>
		<pre>
			<code>im.filter(ImageFilter.GaussianBlur(radius))</code>
		</pre>
		<div style="columns: 2 auto">
			<div style="break-inside: avoid;">
				<code>radius = 3</code> <mark>60 ms</mark>
				<img src="./pictures/gaus.3.pillow.jpeg" width="90%">
			</div>
			<div style="break-inside: avoid;">
				<code>radius = 30</code> <mark>61 ms</mark>
				<img src="./pictures/gaus.30.pillow.jpeg" width="90%">
			</div>
		</div>
	</section>

	<section class="slide">
		<h2>Скорость ресайза в Pillow, Mpx/s</h2>
		<img src="./pictures/perf1.png" height="400">
	</section>

	<section class="slide">
		<h2>Скорость ресайза в Pillow, Mpx/s</h2>
		<img src="./pictures/perf2.png" height="400">
	</section>

	<section class="slide">
		<h2>Скорость ресайза в Pillow, Mpx/s</h2>
		<img src="./pictures/perf3.png" height="400">
	</section>
	
	<section class="slide">
		<h2>Скорость ресайза в Pillow, Mpx/s</h2>
		<img src="./pictures/perf4.png" height="400">
	</section>

	<section class="slide">
		<h2>Ускорение в Pillow-SIMD</h2>
		<ul>
			<li>Ресайз: от <mark>4</mark> до <mark>7</mark> раз</li>
			<li>Размытие: <mark>2,8</mark> раз</li>
			<li>Применение ядра 3x3 или 5x5: <mark>11</mark> раз</li>
			<li>Умножение и деление на альфаканал: в <mark>4</mark> и <mark>10</mark> раза</li>
			<li>Альфа-композиция: <mark>5</mark> раз</li>
			<li>Еще что-то по мелочи</li>
		</ul>
	</section>

	<section class="slide">
		<h2>Какой-то набор операций, Mpx/s</h2>
		<p>Загрузка, поворот на 90°, уменьшение в 2,5 раза, размытие, запись в JPEG</p>
		<img src="./pictures/perf5.png" height="330">
	</section>

	<section class="slide">
		<h2>Набор бенчмарков</h2>
		<p>
			<a href="https://python-pillow.org/pillow-perf/">https://python-pillow.org/pillow-perf/</a><br>
			Страница с результатами
		</p>
		<p>
			<a href="https://github.com/python-pillow/pillow-perf">https://github.com/python-pillow/pillow-perf</a><br>
			Репозиторий
		</p>
	</section>

	<section class="slide">
		<h2>Бенчмарки самого VIPS</h2>
		<img src="./pictures/vips-bench1.png" height="280">
		<p><a href="https://github.com/jcupitt/libvips/wiki/Speed-and-memory-use">
		https://github.com/jcupitt/libvips/wiki/Speed-and-memory-use</a></p>
	</section>

	<section class="slide">
		<h2>Бенчмарки самого VIPS</h2>
		<img src="./pictures/vips-bench2.png" height="280">
		<p>1. Pillow is single-threaded, so the fairest comparison
			 for raw processing speed would be against vips-1thread.</p>
	</section>



	<section class="slide gap">
		<h2>Параллельная работа</h2>
	</section>

	<section class="slide">
		<h2>Метрики производительности</h2>
		<ul>
			<li><b>Реальное время выполнения одной операций</b><br>
				Важно на десктопе
			</li>
			<li><b>Пропускная способность потока операций</b><br>
				Становится более важным на сервере
			</li>
		</ul>
	</section>

	<section class="slide">
		<h2>Способы параллельной работы</h2>
		<ol>
			<li>На уровне команд процессора и данных</li>
		</ol>
		<p>
			Реальное время выполнения уменьшается<br>
			Пропусканая способность растет<br>
			Win-win
		</p>
	</section>

	<section class="slide">
		<h2>Способы параллельной работы</h2>
		<ol>
			<li class="non-zero" data-counter="2">На уровне графических операций</li>
		</ol>
		<p>
			Реальное время выполнения уменьшается<br>
			Пропусканая способность растет далеко не линейно от количества ядер
		</p>
	</section>

	<section class="slide">
		<h2>Способы параллельной работы</h2>
		<ol>
			<li class="non-zero" data-counter="3">На уровне приложения</li>
		</ol>
		<p>
			Реальное время выполнения не меняется<br>
			Пропусканая способность растет пропорционально количеству ядер
		</p>
	</section>

	<section class="slide">
		<h2>Комбинации</h2>
		<p>Первый со вторым</p>
		<p>Первый с третьим</p>
		<p class="red">Второй с третьим нет</p>
	</section>

	<section class="slide">
		<h2>Многопоточность</h2>
		<p>
			<b>Отпускают GIL</b><br>
			Pillow, OpenCV, pyvips, Wand
		</p>
		<p><b>Не отпускает</b><br>
			pgmagick</p>
	</section>

	<section class="slide">
		<h2>Правило N + 1</h2>
		<p>
			Создавать для обработки не более N + 1 воркеров,<br>
			где N — количество ядер или потоков процессора.
		</p>
		<p>Воркер — процес или поток, занятый обработкой.</p>
	</section>

	<section class="slide">
		<h2>Асинхронная работа</h2>
		<p>
			Долгая работа процессора блочит event loop,<br>
			даже если библиотека отпускает GIL
		</p>
		<pre>
			<code>@gen.coroutine</code>
    	<code>def get(self, *args, **kwargs):</code>
			<code>    im = process_image(...)</code>
    	<code>    ...</code>
		</pre>
	</section>

	<section class="slide">
		<h2>Асинхронная работа</h2>
		<pre>
			<code>@run_on_executor(executor=ThreadPoolExecutor(<mark>1</mark>))</code>
    	<code>def process_image(self, ...):</code>
    	<code>    ...</code>
    	<code> </code>
    	<code>def get(self, *args, **kwargs):</code>
			<code>    im = <mark>yield</mark> process_image(...)</code>
			<code>    ...</code>
		<pre>
		</pre>
	</section>



	<section class="slide gap">
		<h2>Ввод/вывод</h2>
	</section>

	<section class="slide">
		<h2>Ввод/вывод Pillow</h2>
		<ul>
			<li>Кодеки для 17 форматов + декодеры еще для 18
			<li class="next">Режимы: <code>RGB</code>, <code>RGBA</code>, <code>L</code>, <code>LA</code>, <code>P</code>. 8-bit only*
			<li class="next">Есть механизмы защиты от DoS-атак
			<li class="next">Нет автоповорота, но есть возможность прочитать EXIF
			<li class="next">Есть режим битых картинок
			<li class="next">Ленивая загрузка
		</ul>
	</section>

	<section class="slide">
		<h2>Режим битых картинок</h2>
		<pre>
			<code>In: from PIL import Image</code>
			<code>In: Image.open('trucated.jpg').save('trucated.out.jpg')</code>
			<code><mark>IOError</mark>: image file is truncated (143 bytes not processed)</code>
		</pre>
	</section>

	<section class="slide">
		<h2>Режим битых картинок</h2>
		<pre>
			<code>In: from PIL import Image, ImageFile</code>
			<code>In: ImageFile.<mark>LOAD_TRUNCATED_IMAGES</mark> = True</code>
			<code>In: Image.open('trucated.jpg').save('trucated.out.jpg')</code>
		</pre>
		<img src="./pictures/trucated.out.jpg">
	</section>

	<section class="slide">
		<h2>Ленивая загрузка</h2>
		<pre>
			<code>In: from PIL import Image</code>
			<code>In: <mark>%time</mark> im = Image.open('cover.jpg')</code>
			<code>Wall time: <mark>1.2 ms</mark></code>
		<span class="next">
			<code>In: im.mode, im.size</code>
			<code>Out: ('RGB', (2152, 1345))</code>
		</span>
		<span class="next">
			<code>In: <mark>%time</mark> im.load()</code>
			<code>Wall time: <mark>73.6 ms</mark></code>
		</span>
		</pre>
	</section>

	<section class="slide">
		<h2>Ввод/вывод Pillow</h2>
		<ul>
			<li>Кодеки для 17 форматов + декодеры еще для 18
			<li>Режимы: <code>RGB</code>, <code>RGBA</code>, <code>L</code>, <code>LA</code>, <code>P</code>, 8-bit only*
			<li>Есть механизмы защиты от DoS-атак
			<li>Нет автоповорота, но есть возможность прочитать EXIF
			<li>Есть режим битых картинок
			<li>Ленивая загрузка
		</ul>
		<p class="stars">⭐ ⭐ ⭐ ⭐</p>
	</section>

	<section class="slide">
		<h2>Ввод/вывод OpenCV</h2>
		<ul>
			<li>Кодеки для 8 форматов, включая WebP и JPEG 2000
			<li class="next">Режимы: <code>RGB</code>, <code>RGBA</code>, <code>L</code>, 16-битный цвет
			<li class="next">Читает битые картинки по-умолчанию
			<li class="next">Автоматически поворачивает, но нет доступа к EXIF и ICC
			<li class="next">Нет ленивой загрузки
			<li class="next">Не открывает PNG в <code>LA</code> формате
		</ul>
		<p class="stars next">⭐ ⭐ ⭐</p>
	</section>

	<section class="slide">
		<h2>Ввод/вывод ImageMagick</h2>
		<ul>
			<li>Кодеки для 66 форматов + декодеры для 34
			<li class="next">Режимы: <code>RGB</code>, <code>RGBA</code>, <code>L</code>, <code>LA</code>, <code>P</code>, 16-битный цвет
			<li class="next">Читает битые картинки по-умолчанию
			<li class="next">Есть доступ к EXIF или ICC
			<li class="next">Нет ленивой загрузки
		</ul>
		<p class="stars next">⭐ ⭐ ⭐ ⭐ ⭐</p>
	</section>

	<section class="slide gap">
		<h2>Питоняшность</h2>
		<p>от слова pythonic</p>
	</section>

	<section class="slide">
		<h2>Питоняшность Pillow</h2>
		<pre>
			<code>from PIL import Image</code>
			<code>Image.open('cover.jpg') \</code>
			<code class="mark">    .resize((640, 480), Image.BICUBIC) \</code>
			<code>    .save('output.png')</code>
		</pre>
	</section>

	<section class="slide">
		<h2>Питоняшность Pillow</h2>
		<pre>
			<code>from PIL import Image</code>
			<code>Image.open('cover.jpg') \</code>
			<code class="mark">    .thumbnail((640, 480)) \</code>
			<code>    .save('output.png')</code>
			<code><mark>AttributeError</mark>: 'NoneType' object has no attribute 'save'</code>
		</pre>
	</section>

	<section class="slide">
		<h2>Питоняшность Pillow</h2>
		<pre>
			<code>from PIL import Image, <mark>ImageFilter</mark></code>
			<code>Image.open('cover.jpg') \</code>
			<code>    .resize((640, 480), Image.BICUBIC) \</code>
			<code class="mark">    .filter(ImageFilter.GaussianBlur(10)) \</code>
			<code>    .save('output.png')</code>
		</pre>
	</section>

	<section class="slide">
		<h2>Питоняшность Pillow</h2>
		<ul>
			<li>Изображение — объект со chainable методами
			<li>Иногда это правило нарушается
			<li>Операции разбросаны между методами, <code>ImageFilter</code> и <code>ImageOps</code>
			<li>Странные исключения: <code>SyntaxError</code>, <code>IOError</code>, <code>struct.error</code>
		</ul>
		<p class="next stars">⭐ ⭐ ⭐</p>
	</section>

	<section class="slide">
		<h2>Питоняшность OpenCV</h2>
		<pre style="font-size: 20px">
			<code>import cv2</code>
			<code>im = cv2.imread('cover.jpg')</code>
			<code>im = cv2.resize(im, (160, 100), interpolation=cv2.INTER_CUBIC)</code>
			<code>cv2.imwrite('output.png', im)</code>
		</pre>
		<img class="next" src="./pictures/cv2.inter_cubic.png"
				 width="320" style="image-rendering: pixelated">
		<img class="next" src="./pictures/cv2.inter_area.2.png"
				 width="320" style="image-rendering: pixelated">
	</section>

	<section class="slide">
		<h2>Питоняшность OpenCV</h2>
		<pre>
			<code>import cv2</code>
			<code>im = cv2.imread('cover.jpg')</code>
			<code>im = cv2.resize(im, (160, 100), interpolation=cv2.INTER_AREA)</code>
			<code>cv2.imwrite('output.png', im)</code>
		</pre>
	</section>

	<section class="slide">
		<h2>Питоняшность OpenCV</h2>
		<pre>
			<code>import cv2</code>
			<code>im = cv2.imread(filename, <mark>-1</mark>)</code>
			<code>height, width = im.shape<mark>[:2]</mark></code>
			<code>has_alpha = len(im.shape) == <mark>3</mark> and im.shape<mark>[2]</mark> == <mark>4</mark></code>
			<code>inter = cv2.INTER_AREA if width > 300 else cv2.INTER_CUBIC</code>
      <code>if has_alpha:</code>
      <code>    im = cv2.cvtColor(im, <mark>cv2.COLOR_RGBA2M_RGBA</mark>)</code>
			<code class="next"><mark>...</mark></code>
		</pre>
	</section>

  <section class="slide">
    <h2>Питоняшность OpenCV</h2>
    <pre>
      <code><mark>...</mark></code>
      <code>im = cv2.resize(im, (320, 200), interpolation=inter)</code>
      <code>if has_alpha:</code>
      <code>    im = cv2.cvtColor(im, <mark>cv2.COLOR_M_RGBA2RGBA</mark>)</code>
      <code>cv2.imwrite('output.png', im)</code>
    </pre>
  </section>

	<section class="slide">
		<h2>Питоняшность OpenCV</h2>
		<ul>
			<li>Изображение — массив numpy без методов
			<li class="next">В изображении нет информации о его режиме
			<li class="next">Методы слишком низкоуровневые, нужно много оберток
			<li class="next">Огромное количество магических констант
			<li class="next">Вы не узнаете ничего полезного из исключений
		</ul>
		<p class="next stars">⭐</p>
	</section>

	<section class="slide">
		<h2>Питоняшность Wand</h2>
		<pre>
      <code>from wand.image import Image</code>
      <code>im = Image(filename='cover.jpg')</code>
      <code>im.resize(320, 200)</code>
      <code>im.save(filename='output.png')</code>
      <code class="next">im.<mark>destroy</mark>()</code>
    </pre>
		<p class="next stars">⭐ ⭐ ⭐</p>
	</section>


	<div class="progress"></div>

	<script src="node_modules/shower-core/shower.min.js"></script>
	<!-- Copyright © 2017 Yours Truly, Famous Inc. -->

</body>
</html>
